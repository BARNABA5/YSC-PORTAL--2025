<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - YSC Registrations</title>
  <style>
    body { font-family: Arial; margin: 20px; background: #3858b3; color: #fff; }
    .card { background: #fff; color: #000; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
    th { background: #0077cc; color: #fff; }
    button { padding: 8px 15px; margin: 5px 0; cursor: pointer; border: none; background: #0077cc; color: #fff; border-radius: 5px; }
    button:hover { background: #005fa3; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Admin Login</h2>
    <input type="password" id="tokenInput" placeholder="Enter admin token">
    <button id="authBtn">View Registrations</button>
    <p id="authMsg"></p>
  </div>

  <div class="card" id="tableSection" style="display:none;">
   <button id="refreshBtn">Refresh</button>
<button id="downloadBtn">Download CSV</button>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Timestamp</th>
          <th>Name</th>
          <th>Gender</th>
          <th>Age</th>
          <th>Outstation</th>
          <th>Next of Kin</th>
          <th>Next of Kin Contact</th>
          <th>Contact</th>
        </tr>
      </thead>
      <tbody id="registrationsBody"></tbody>
    </table>
  </div>

  <script>
    const ADMIN_API_URL = "https://script.google.com/macros/s/AKfycbw9EW7KR2eC_kNxrrqPnk6TKfIT9LmDUYSdlns52C-uA591kVyAgQyaR1UuKHNuacZfTA/exec";
    const authMsg = document.getElementById("authMsg");
    const tokenInput = document.getElementById("tokenInput");
    const authBtn = document.getElementById("authBtn");
    const tableSection = document.getElementById("tableSection");
    const registrationsBody = document.getElementById("registrationsBody");
    const refreshBtn = document.getElementById("refreshBtn");

    function showMessage(txt, color='black'){
      authMsg.textContent = txt;
      authMsg.style.color = color;
    }

    async function fetchRegistrations(token){
      showMessage("Fetching...", "black");
      try {
        const resp = await fetch(`${ADMIN_API_URL}?token=${encodeURIComponent(token)}`);
        const json = await resp.json();

        if(json.result !== "success") throw new Error(json.message || "Unauthorized");

        registrationsBody.innerHTML = "";
        json.data.forEach((row, i) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${i+1}</td>
            <td>${row.timestamp}</td>
            <td>${row.name}</td>
            <td>${row.gender}</td>
            <td>${row.age}</td>
            <td>${row.outstation}</td>
            <td>${row.kin}</td>
            <td>${row.kinContact}</td>
            <td>${row.contact}</td>
          `;
          registrationsBody.appendChild(tr);
        });

        tableSection.style.display = "block";
        showMessage(`Loaded ${json.data.length} records`, "green");
      } catch(err) {
        showMessage(err.message, "red");
      }
    }

    authBtn.addEventListener("click", () => {
      const token = tokenInput.value.trim();
      if(!token) return showMessage("Enter token", "orange");
      fetchRegistrations(token);
    });

    refreshBtn.addEventListener("click", () => {
      const token = tokenInput.value.trim();
      if(!token) return showMessage("Enter token", "orange");
      fetchRegistrations(token);
    });
    function convertToCSV(objArray) {
  const array = typeof objArray != 'object' ? JSON.parse(objArray) : objArray;
  let str = 'Timestamp,Name,Gender,Age,Outstation,Next of Kin,Kin Contact,Contact\n';

  for (let i = 0; i < array.length; i++) {
    let line = '';
    for (let index in array[i]) {
      if (line !== '') line += ',';
      // Escape commas in data
      line += `"${array[i][index]}"`;
    }
    str += line + '\n';
  }
  return str;
}

document.getElementById("downloadBtn").addEventListener("click", () => {
  const token = tokenInput.value.trim();
  if (!token) return showMessage("Enter token to download", "orange");

  fetch(`${ADMIN_API_URL}?token=${encodeURIComponent(token)}`)
    .then(res => res.json())
    .then(json => {
      if (json.result !== "success") throw new Error(json.message || "Unauthorized");
      const csv = convertToCSV(json.data);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `YSC_Registrations_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      showMessage("CSV downloaded âœ…", "green");
    })
    .catch(err => {
      showMessage(err.message, "red");
    });
});

  </script>
</body>
</html>
